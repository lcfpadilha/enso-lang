name: Test Ensō Compiler

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: Test enso build command (compilation without execution)
      run: |
        # Build library from example files - tests compilation only
        enso build examples/0_getting_started.enso --name getting_started --output __enso_test_build_0__
        enso build examples/1_structured_data_extraction.enso --name data_extraction --output __enso_test_build_1__
        enso build examples/4_complete_hiring_workflow.enso --name hiring --output __enso_test_build_4__
        
        # Verify output directories were created
        test -d __enso_test_build_0__ && echo "✓ Build 0 output directory created"
        test -f __enso_test_build_0__/getting_started/__init__.py && echo "✓ Built module has __init__.py"
        test -d __enso_test_build_1__ && echo "✓ Build 1 output directory created"
        test -d __enso_test_build_4__ && echo "✓ Build 4 output directory created"
    
    - name: Test enso analyse command (cost estimation)
      run: |
        # Test cost estimation without API calls - this is safe
        enso analyse examples/0_getting_started.enso
        enso analyse examples/4_complete_hiring_workflow.enso
        echo "✓ Cost estimation works"
    
    - name: Test enso analyse --save-report (JSON export)
      run: |
        # Test JSON report generation
        enso analyse examples/0_getting_started.enso --save-report analysis_report.json
        test -f analysis_report.json && echo "✓ JSON report generated"
        grep -q "ai_calls" analysis_report.json && echo "✓ Report contains analysis data"
    
    - name: Test enso test command (mocked - safe, no API calls)
      run: |
        # Run mocked tests (no API calls, safe in CI)
        enso test examples/0_test_getting_started.enso
        enso test examples/5_concurrent_batch_processing.enso
        echo "✓ Mocked tests completed"
    
    - name: Test enso --verbose flag (on build command)
      run: |
        # Test verbose flag on a safe build command (should not error)
        enso --verbose build examples/0_getting_started.enso --name verbose_test --output __enso_verbose_test__ 2>&1 && echo "✓ Verbose flag works"
    
    - name: Test stdin support with run (via analyse mode - safe)
      run: |
        # Test reading from stdin with analyse command (mocked, no API execution)
        cat examples/0_getting_started.enso | enso analyse - 2>&1 && echo "✓ Stdin pipe support works"
    
    - name: Test error handling (invalid file)
      run: |
        # Test invalid file handling - should fail gracefully
        if enso run nonexistent.enso 2>&1 | grep -i "error\|not found"; then
          echo "✓ Invalid file error handling works"
        else
          echo "⚠ Expected error not shown, but command failed as expected"
        fi
    
    - name: Test compilation of project example
      run: |
        # Just test compilation - don't execute (requires API keys)
        cd project-example
        enso build main.enso --name project_test --output __project_test_build__
        cd ..
        test -d project-example/__project_test_build__ && echo "✓ Project example compiles successfully"
